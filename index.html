<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced SAT Practice Test Generator</title>
  <style>
    :root{--bg:#0b0f19;--card:#12182a;--muted:#9aa4b2;--fg:#e6edf3;--brand:#6aa6ff;--accent:#79f2c0;--danger:#ff6b6b}
    *{box-sizing:border-box} 
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b0f19,#0e1425);} 
    .wrap{max-width:1200px;margin:0 auto;padding:28px}
    h1{color:var(--fg);font-weight:800;letter-spacing:0.3px;margin:0 0 8px;font-size:clamp(22px,4vw,34px)}
    p.lead{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .card{background:rgba(18,24,42,.8);backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    label{display:block;color:var(--fg);font-size:14px;margin:8px 0 6px}
    select,input[type="number"],button,.pill{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1528;color:var(--fg)}
    button{cursor:pointer;font-weight:700;background:linear-gradient(135deg,var(--brand),#7cc1ff);color:#071126;border:none;transition:all 0.3s}
    button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(106,166,255,0.3)}
    button.secondary{background:#0e1528;color:var(--fg);border:1px solid rgba(255,255,255,.12)}
    button.ai-btn{background:linear-gradient(135deg,var(--accent),#5ee3b3);margin-left:8px}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{width:auto;display:inline-flex;align-items:center;gap:8px}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;background:#0e1730;color:var(--muted);font-size:12px;margin-right:6px}
    .q{margin-top:20px;padding:16px;background:rgba(15,26,48,.6);border-radius:12px;border:1px solid rgba(255,255,255,.05)}
    .q h4{margin:0 0 12px;color:var(--fg);font-size:16px;line-height:1.4}
    .opt{display:grid;gap:8px;margin:15px 0}
    .opt label{display:flex;gap:12px;align-items:flex-start;padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#0b1224;cursor:pointer;transition:all 0.2s}
    .opt label:hover{background:#0f1630;border-color:rgba(106,166,255,.3)}
    .opt label.correct{background:rgba(121,242,192,.1);border-color:var(--accent)}
    .opt label.incorrect{background:rgba(255,107,107,.1);border-color:var(--danger)}
    .timer{font-variant-numeric:tabular-nums;font-weight:800}
    .good{color:var(--accent)} .bad{color:var(--danger)}
    .hidden{display:none}
    .footer{color:var(--muted);font-size:12px;margin-top:24px}
    .scorebox{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .scorechip{background:#0f1a31;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;color:var(--fg)}
    .passage{background:#0f1a31;padding:16px;border-radius:12px;margin:12px 0;color:var(--muted);border-left:4px solid var(--brand);line-height:1.6}
    .finish-btn{margin-top:20px;background:linear-gradient(135deg,var(--accent),#5ee3b3);color:#071126}
    .explanation{margin-top:12px;padding:12px;background:#0a1020;border-radius:8px;color:var(--muted);font-size:14px}
    .notification{position:fixed;top:20px;right:20px;background:var(--accent);color:#071126;padding:12px 20px;border-radius:8px;font-weight:600;z-index:1001;transform:translateY(-100px);transition:transform 0.3s}
    .notification.show{transform:translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Advanced SAT Practice Generator</h1>
    <p class="lead">Complete SAT preparation with 25 questions per module, integrated calculator, and AI assistance. Covers Algebra I-II, Geometry, Calculus, and English 9-12.</p>

    <div class="grid">
      <div class="card">
        <label>Section</label>
        <select id="section">
          <option value="rw">Reading & Writing</option>
          <option value="math">Math</option>
          <option value="mixed">Mixed (RW + Math)</option>
        </select>
        <label>Questions per Module (Fixed: 25)</label>
        <input type="number" id="count" value="25" readonly style="background:#1a2332" />
        <div class="flex" style="margin-top:10px">
          <label class="pill"><input type="checkbox" id="adaptive"/> Adaptive Difficulty</label>
          <label class="pill"><input type="checkbox" id="timed"/> Timed Test</label>
        </div>
        <div class="flex" style="margin-top:10px">
          <button id="startBtn">Generate Test</button>
          <button class="secondary" id="resetBtn">Reset</button>
        </div>
        <p id="clock" class="tag timer hidden">00:00</p>
      </div>
      
      <div class="card" id="status">
        <div class="scorebox">
          <span class="scorechip">Module: <b id="mnum">–</b></span>
          <span class="scorechip">Correct: <b id="correct">0</b></span>
          <span class="scorechip">Score: <b id="scaled">—</b></span>
        </div>
        <div id="progress" class="tag" style="margin-top:10px">Ready to Start</div>
      </div>
    </div>

    <div id="testArea" class="card" style="margin-top:16px">
      <h3 style="color:var(--fg);margin:0 0 16px">Click "Generate Test" to begin your SAT practice</h3>
      <p style="color:var(--muted)">Select your preferences above and start practicing with real SAT-style questions.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="color:var(--fg);margin:0 0 8px">Tools & Resources</h3>
      <div class="flex">
        <button id="exportBtn">Export Results</button>
        <button class="secondary" id="importBtn">Import Questions</button>
        <button class="ai-btn" id="toggleAI">AI Helper</button>
        <button class="secondary" id="calcBtn">Calculator</button>
      </div>
    </div>

    <p class="footer">Advanced SAT Practice Generator • Not affiliated with College Board • For practice only</p>
  </div>

  <div id="notification" class="notification">Test generated successfully!</div>

<script>
// Comprehensive SAT Question Banks
const questionBanks = {
  math: [
    {
      id: "m1", stem: "If 3x + 7 = 22, what is the value of x?", 
      choices: ["3", "5", "7", "15"], ans: 1, diff: 1,
      expl: "Subtract 7 from both sides: 3x = 15. Divide by 3: x = 5"
    },
    {
      id: "m2", stem: "A bakery sells cupcakes for $3 each and cookies for $2 each. If Maria buys 4 cupcakes and some cookies for a total of $20, how many cookies did she buy?", 
      choices: ["2", "3", "4", "5"], ans: 2, diff: 2,
      expl: "Cupcakes cost 4 × $3 = $12. Remaining: $20 - $12 = $8. Cookies: $8 ÷ $2 = 4"
    },
    {
      id: "m3", stem: "Which expression is equivalent to 2(x + 3) - 4(x - 1)?", 
      choices: ["-2x + 10", "-2x + 2", "6x + 2", "2x + 10"], ans: 0, diff: 2,
      expl: "2(x + 3) - 4(x - 1) = 2x + 6 - 4x + 4 = -2x + 10"
    },
    {
      id: "m4", stem: "If y = 2x + 5 and x = 3, what is the value of y?", 
      choices: ["8", "10", "11", "13"], ans: 2, diff: 1,
      expl: "Substitute x = 3: y = 2(3) + 5 = 6 + 5 = 11"
    },
    {
      id: "m5", stem: "A rectangular garden has length (2x + 3) feet and width (x - 1) feet. What is the area in square feet?", 
      choices: ["2x² + x - 3", "2x² - 2x + 3", "2x² + x + 3", "3x + 2"], ans: 0, diff: 2,
      expl: "Area = length × width = (2x + 3)(x - 1) = 2x² - 2x + 3x - 3 = 2x² + x - 3"
    },
    {
      id: "m6", stem: "Sarah's car gets 28 miles per gallon. If she drives 336 miles, how many gallons of gas does she use?", 
      choices: ["10", "12", "14", "16"], ans: 1, diff: 1,
      expl: "Gallons used = Total miles ÷ Miles per gallon = 336 ÷ 28 = 12"
    },
    {
      id: "m7", stem: "Solve for x: 5x - 8 = 3x + 12", 
      choices: ["5", "8", "10", "20"], ans: 2, diff: 2,
      expl: "5x - 8 = 3x + 12 → 5x - 3x = 12 + 8 → 2x = 20 → x = 10"
    },
    {
      id: "m8", stem: "A phone plan costs $40 per month plus $0.10 per text message. If the monthly bill is $52, how many text messages were sent?", 
      choices: ["80", "100", "120", "140"], ans: 2, diff: 2,
      expl: "Extra cost: $52 - $40 = $12. Text messages: $12 ÷ $0.10 = 120"
    },
    {
      id: "m9", stem: "What is the slope of the line passing through points (2, 5) and (8, 17)?", 
      choices: ["1", "2", "3", "4"], ans: 1, diff: 2,
      expl: "Slope = (y₂ - y₁)/(x₂ - x₁) = (17 - 5)/(8 - 2) = 12/6 = 2"
    },
    {
      id: "m10", stem: "If 2x + 3y = 12 and x = 3, what is the value of y?", 
      choices: ["1", "2", "3", "4"], ans: 1, diff: 2,
      expl: "2(3) + 3y = 12 → 6 + 3y = 12 → 3y = 6 → y = 2"
    },
    {
      id: "m11", stem: "What are the solutions to x² - 5x + 6 = 0?", 
      choices: ["x = 2 or x = 3", "x = 1 or x = 6", "x = -2 or x = -3", "x = 5 or x = 6"], ans: 0, diff: 2,
      expl: "Factor: (x - 2)(x - 3) = 0, so x = 2 or x = 3"
    },
    {
      id: "m12", stem: "A right triangle has legs of length 9 and 12. What is the length of the hypotenuse?", 
      choices: ["15", "18", "21", "25"], ans: 0, diff: 2,
      expl: "Using Pythagorean theorem: c² = 9² + 12² = 81 + 144 = 225, so c = 15"
    },
    {
      id: "m13", stem: "A circular pizza has diameter 16 inches. What is its area? (Use π ≈ 3.14)", 
      choices: ["50.24 in²", "100.48 in²", "200.96 in²", "803.84 in²"], ans: 2, diff: 2,
      expl: "Radius = 8 inches. Area = πr² = 3.14 × 8² = 3.14 × 64 = 200.96 in²"
    },
    {
      id: "m14", stem: "In a right triangle, if sin θ = 3/5, what is cos θ?", 
      choices: ["3/4", "4/5", "4/3", "5/4"], ans: 1, diff: 3,
      expl: "If sin θ = 3/5, then opposite = 3, hypotenuse = 5. Using Pythagorean theorem: adjacent = 4. So cos θ = 4/5"
    },
    {
      id: "m15", stem: "A survey of 500 students found that 60% prefer online classes. How many students prefer online classes?", 
      choices: ["250", "300", "350", "400"], ans: 1, diff: 1,
      expl: "60% of 500 = 0.60 × 500 = 300 students"
    },
    {
      id: "m16", stem: "If f(x) = x² - 4x + 3, what is f(-2)?", 
      choices: ["15", "11", "7", "3"], ans: 0, diff: 2,
      expl: "f(-2) = (-2)² - 4(-2) + 3 = 4 + 8 + 3 = 15"
    },
    {
      id: "m17", stem: "What is the derivative of f(x) = 3x² + 2x - 1?", 
      choices: ["6x + 2", "3x + 2", "6x - 1", "3x - 1"], ans: 0, diff: 3,
      expl: "f'(x) = d/dx[3x²] + d/dx[2x] + d/dx[-1] = 6x + 2 + 0 = 6x + 2"
    },
    {
      id: "m18", stem: "A cylinder has radius 4 cm and height 10 cm. What is its volume? (Use π ≈ 3.14)", 
      choices: ["251.2 cm³", "502.4 cm³", "1005.6 cm³", "2010.4 cm³"], ans: 1, diff: 2,
      expl: "Volume = πr²h = 3.14 × 4² × 10 = 3.14 × 16 × 10 = 502.4 cm³"
    },
    {
      id: "m19", stem: "The test scores in a class are: 85, 90, 78, 92, 88, 85, 90, 95. What is the median score?", 
      choices: ["87", "88", "89", "90"], ans: 2, diff: 2,
      expl: "Ordered scores: 78, 85, 85, 88, 90, 90, 92, 95. Median = average of 4th and 5th values = (88 + 90)/2 = 89"
    },
    {
      id: "m20", stem: "A bag contains 5 red marbles, 3 blue marbles, and 2 green marbles. What is the probability of drawing a blue marble?", 
      choices: ["1/5", "3/10", "1/3", "2/5"], ans: 1, diff: 2,
      expl: "Total marbles = 5 + 3 + 2 = 10. Probability of blue = 3/10"
    },
    {
      id: "m21", stem: "If log₂(x) = 5, what is the value of x?", 
      choices: ["10", "25", "32", "64"], ans: 2, diff: 3,
      expl: "log₂(x) = 5 means 2⁵ = x, so x = 32"
    },
    {
      id: "m22", stem: "What is the value of tan(45°)?", 
      choices: ["0", "1/2", "1", "√2"], ans: 2, diff: 2,
      expl: "In a 45-45-90 triangle, opposite equals adjacent, so tan(45°) = 1"
    },
    {
      id: "m23", stem: "A 20-foot ladder leans against a wall at an angle of 60° with the ground. How high up the wall does it reach?", 
      choices: ["10 feet", "10√3 feet", "17.3 feet", "20 feet"], ans: 2, diff: 3,
      expl: "Height = 20 × sin(60°) = 20 × (√3/2) = 10√3 ≈ 17.3 feet"
    },
    {
      id: "m24", stem: "In the coordinate plane, what is the distance between points (1, 3) and (7, 11)?", 
      choices: ["10", "12", "14", "16"], ans: 0, diff: 3,
      expl: "Distance = √[(7-1)² + (11-3)²] = √[36 + 64] = √100 = 10"
    },
    {
      id: "m25", stem: "The function g(x) = 2^x models exponential growth. What is g(4)?", 
      choices: ["8", "16", "32", "64"], ans: 1, diff: 2,
      expl: "g(4) = 2⁴ = 16"
    }
  ],

  rw: [
    {
      id: "rw1", 
      stem: "The student council ___ planning a fundraiser for the new computer lab.",
      choices: ["is", "are", "were", "have been"], ans: 0, diff: 1,
      expl: "The subject 'student council' is a collective noun treated as singular, so use 'is.'"
    },
    {
      id: "rw2",
      stem: "Maria studied for three hours last night; ___, she felt confident about the test.",
      choices: ["however", "therefore", "although", "meanwhile"], ans: 1, diff: 2,
      expl: "'Therefore' shows the logical consequence of studying hard."
    },
    {
      id: "rw3",
      stem: "The research team, ___ has been studying climate change for over a decade, published their findings.",
      choices: ["who", "which", "that", "whom"], ans: 1, diff: 2,
      expl: "'Which' is correct for a non-restrictive clause referring to the team as an entity."
    },
    {
      id: "rw4",
      stem: "Each of the students ___ responsible for bringing their own supplies.",
      choices: ["is", "are", "were", "have been"], ans: 0, diff: 2,
      expl: "'Each' is singular, so use 'is.' The pronoun 'their' is acceptable for singular antecedents in modern usage."
    },
    {
      id: "rw5",
      stem: "After reviewing the data, the scientist concluded that the hypothesis ___ incorrect.",
      choices: ["is", "was", "were", "are"], ans: 1, diff: 2,
      expl: "The hypothesis (singular subject) requires 'was' to maintain past tense consistency."
    },
    {
      id: "rw6",
      stem: "The book that I borrowed from the library ___ on the table.",
      choices: ["is laying", "is lying", "are laying", "are lying"], ans: 1, diff: 2,
      expl: "'Lying' means resting in a position. 'Laying' requires a direct object."
    },
    {
      id: "rw7",
      stem: "Neither the teacher nor the students ___ prepared for the sudden fire drill.",
      choices: ["was", "were", "is", "are"], ans: 1, diff: 2,
      expl: "With 'neither...nor,' the verb agrees with the nearer subject ('students' is plural)."
    },
    {
      id: "rw8",
      stem: "The committee will meet tomorrow to discuss ___ the new policy should be implemented.",
      choices: ["weather", "whether", "wether", "where"], ans: 1, diff: 1,
      expl: "'Whether' introduces a choice between alternatives."
    },
    {
      id: "rw9",
      stem: "Having finished her homework, Sarah decided to ___ down for a nap.",
      choices: ["lay", "lie", "laid", "lain"], ans: 1, diff: 2,
      expl: "'Lie' means to recline. No direct object is involved."
    },
    {
      id: "rw10",
      stem: "The museum's new exhibit, ___ features artifacts from ancient Rome, opens next week.",
      choices: ["that", "which", "who", "what"], ans: 1, diff: 2,
      expl: "'Which' is used in non-restrictive clauses (set off by commas)."
    },
    {
      id: "rw11",
      stem: "Which revision best combines these sentences?\n\nThe storm was approaching rapidly. The family decided to postpone their picnic. The weather forecast predicted heavy rain.",
      choices: [
        "Because the storm was approaching rapidly and the weather forecast predicted heavy rain, the family decided to postpone their picnic.",
        "The storm was approaching rapidly, the family decided to postpone their picnic, the weather forecast predicted heavy rain.",
        "The family decided to postpone their picnic, the storm was approaching rapidly and the weather forecast predicted heavy rain.",
        "The storm was approaching rapidly; therefore, the family decided to postpone their picnic; the weather forecast predicted heavy rain."
      ], ans: 0, diff: 2,
      expl: "Option A effectively combines all three ideas with proper subordination and logical flow."
    },
    {
      id: "rw12",
      stem: "Which sentence demonstrates the most effective use of parallel structure?",
      choices: [
        "The conference will focus on innovation, collaboration, and developing leadership.",
        "The conference will focus on innovation, collaboration, and leadership development.", 
        "The conference will focus on innovation, collaboration, and leadership.",
        "The conference will focus on being innovative, collaboration, and leadership."
      ], ans: 2, diff: 2,
      expl: "Option C uses three parallel nouns: innovation, collaboration, and leadership."
    },
    {
      id: "rw13",
      stem: "The following passage is from a 2023 environmental science journal.\n\nClimate change represents one of the most pressing challenges of our time. Rising global temperatures have triggered a cascade of environmental changes, from melting ice caps to shifting precipitation patterns. These changes don't just affect polar bears and penguins; they have profound implications for human societies, agriculture, and economic systems worldwide. Recent studies indicate that crop yields in major agricultural regions could decline by up to 25% by 2050 if current trends continue.\n\nAccording to the passage, climate change:",
      choices: [
        "only affects Arctic animals like polar bears",
        "primarily impacts environmental systems", 
        "has wide-ranging effects on multiple systems",
        "mainly threatens economic stability"
      ], ans: 2, diff: 2,
      expl: "The passage explicitly states climate change affects environmental systems, human societies, agriculture, and economic systems - showing wide-ranging effects."
    },
    {
      id: "rw14",
      stem: "Based on the previous passage, the author's primary purpose is to:",
      choices: [
        "persuade readers to take immediate action on climate change",
        "explain the comprehensive nature of climate change impacts",
        "criticize governments for inadequate climate policies", 
        "provide solutions to agricultural challenges"
      ], ans: 1, diff: 2,
      expl: "The author presents factual information about the broad scope of climate change effects without advocating specific actions or solutions."
    },
    {
      id: "rw15",
      stem: "The following excerpt is from Frederick Douglass's 'Narrative of the Life of Frederick Douglass, an American Slave' (1845).\n\n'I have often been awakened at the dawn of day by the most heart-rending shrieks of an own aunt of mine, whom he used to tie up to a joist, and whip upon her naked back till she was literally covered with blood. No words, no tears, no prayers, from his gory victim, seemed to move his iron heart from its bloody purpose.'\n\nThe phrase 'iron heart' most effectively conveys:",
      choices: [
        "the master's physical strength",
        "the master's emotional coldness and cruelty",
        "the master's determination to maintain order",
        "the master's mechanical approach to punishment"
      ], ans: 1, diff: 3,
      expl: "The metaphor 'iron heart' suggests someone unmoved by emotion, highlighting the master's cruel indifference to suffering."
    },
    {
      id: "rw16",
      stem: "The following excerpt is from Maya Angelou's 'I Know Why the Caged Bird Sings.'\n\n'The caged bird sings with a fearful trill / of things unknown but longed for still / and his tune is heard on the distant hill / for the caged bird sings of freedom.'\n\nThe 'caged bird' most likely symbolizes:",
      choices: [
        "literal imprisonment",
        "oppression and the desire for liberation", 
        "the beauty of nature",
        "childhood innocence"
      ], ans: 1, diff: 3,
      expl: "In Angelou's work, the caged bird is a metaphor for those who face oppression but still yearn for freedom and express that longing."
    },
    {
      id: "rw17",
      stem: "In the previous excerpt, the phrase 'fearful trill' suggests:",
      choices: [
        "the bird's musical ability",
        "anxiety mixed with hope",
        "the bird's physical weakness",
        "anger toward the captor"
      ], ans: 1, diff: 3,
      expl: "The combination of 'fearful' (anxiety) and 'trill' (hopeful song) captures the complex emotions of someone oppressed yet still hopeful."
    },
    {
      id: "rw18",
      stem: "Which revision best improves the clarity and conciseness of this sentence?\n\n'Due to the fact that the weather was extremely bad and dangerous, the school officials made the decision to cancel all outdoor activities.'",
      choices: [
        "Because of extremely bad and dangerous weather, school officials decided to cancel all outdoor activities.",
        "Due to bad weather conditions, the school made a decision about canceling outdoor activities.", 
        "The school canceled outdoor activities because of dangerous weather.",
        "School officials, due to weather, canceled activities that were outdoors."
      ], ans: 2, diff: 2,
      expl: "Option C eliminates redundancy ('extremely bad and dangerous,' 'made the decision') while maintaining clarity and directness."
    },
    {
      id: "rw19",
      stem: "In academic writing, which transition would best show contrast between two opposing viewpoints?",
      choices: ["Furthermore", "Nevertheless", "Similarly", "Consequently"], ans: 1, diff: 2,
      expl: "'Nevertheless' effectively signals contrast and opposition between ideas."
    },
    {
      id: "rw20",
      stem: "Which sentence best demonstrates sophisticated vocabulary and sentence structure for a college-level essay?",
      choices: [
        "The book was really good and had lots of interesting parts that made me think.",
        "This literary work effectively employs symbolism to explore complex themes of identity and belonging.",
        "I thought the author wrote a pretty decent story with some cool characters.",
        "The story had good writing and the plot was exciting with surprising twists."
      ], ans: 1, diff: 3,
      expl: "Option B uses academic vocabulary ('employs,' 'symbolism,' 'complex themes') and sophisticated structure appropriate for college writing."
    },
    {
      id: "rw21",
      stem: "In the sentence 'The politician's speech was filled with platitudes that failed to address the substantive issues,' the word 'platitudes' most nearly means:",
      choices: ["harsh criticisms", "empty clichés", "detailed explanations", "personal attacks"], ans: 1, diff: 3,
      expl: "Platitudes are trite, meaningless statements - essentially empty clichés that lack substance."
    },
    {
      id: "rw22",
      stem: "The scientist's hypothesis proved to be 'untenable' after the experiments. In this context, 'untenable' means:",
      choices: ["impossible to defend", "difficult to understand", "expensive to test", "dangerous to pursue"], ans: 0, diff: 3,
      expl: "Untenable means not capable of being defended or maintained, especially when faced with criticism or attack."
    },
    {
      id: "rw23",
      stem: "The author's tone in the passage can best be described as:",
      choices: ["optimistic and encouraging", "objective and informative", "pessimistic and critical", "emotional and persuasive"], ans: 1, diff: 2,
      expl: "The author presents facts without emotional language or bias, maintaining an objective, informative tone."
    },
    {
      id: "rw24",
      stem: "Which of the following best describes the structure of the argument?",
      choices: ["cause and effect", "compare and contrast", "problem and solution", "chronological sequence"], ans: 0, diff: 2,
      expl: "The passage establishes causes (climate change) and describes their effects (environmental and social impacts)."
    },
    {
      id: "rw25",
      stem: "The word 'cascade' in the context of environmental changes most nearly means:",
      choices: ["waterfall", "series of interconnected effects", "rapid decline", "unexpected change"], ans: 1, diff: 2,
      expl: "In this context, 'cascade' refers to a series of effects where one change triggers another in a chain reaction."
    }
  ],
  
  mixed: []
};

// Generate mixed questions by combining math and rw
questionBanks.mixed = [...questionBanks.math.slice(0, 12), ...questionBanks.rw.slice(0, 13)];

// Test state management
let state = {
  section: 'rw',
  module: 1, 
  current: [],
  answers: {},
  correct: 0,
  attempted: 0,
  timed: false,
  adaptive: false,
  perModule: 25,
  timer: null,
  timeLeft: 0,
  finished: false,
  testStarted: false
};

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('startBtn').addEventListener('click', startTest);
  document.getElementById('resetBtn').addEventListener('click', resetTest);
  document.getElementById('exportBtn').addEventListener('click', exportResults);
  document.getElementById('importBtn').addEventListener('click', importQuestions);
  document.getElementById('toggleAI').addEventListener('click', openAIHelper);
  document.getElementById('calcBtn').addEventListener('click', openCalculator);
});

function startTest() {
  state.section = document.getElementById('section').value;
  state.adaptive = document.getElementById('adaptive').checked;
  state.timed = document.getElementById('timed').checked;
  state.testStarted = true;
  state.module = 1;
  state.answers = {};
  state.correct = 0;
  state.attempted = 0;
  state.finished = false;
  
  renderModule();
  showNotification('Test generated successfully!');
}

function resetTest() {
  clearInterval(state.timer);
  state = {
    section: 'rw',
    module: 1, 
    current: [],
    answers: {},
    correct: 0,
    attempted: 0,
    timed: false,
    adaptive: false,
    perModule: 25,
    timer: null,
    timeLeft: 0,
    finished: false,
    testStarted: false
  };
  
  document.getElementById('section').value = 'rw';
  document.getElementById('adaptive').checked = false;
  document.getElementById('timed').checked = false;
  document.getElementById('correct').textContent = '0';
  document.getElementById('scaled').textContent = '—';
  document.getElementById('mnum').textContent = '–';
  document.getElementById('progress').textContent = 'Ready to Start';
  document.getElementById('clock').classList.add('hidden');
  
  const testArea = document.getElementById('testArea');
  testArea.innerHTML = `
    <h3 style="color:var(--fg);margin:0 0 16px">Click "Generate Test" to begin your SAT practice</h3>
    <p style="color:var(--muted)">Select your preferences above and start practicing with real SAT-style questions.</p>
  `;
  
  showNotification('Test reset successfully!');
}

function exportResults() {
  if (!state.testStarted) {
    showNotification('No test data to export. Start a test first!', 'error');
    return;
  }
  
  const results = {
    section: state.section,
    module: state.module,
    correct: state.correct,
    attempted: state.attempted,
    score: estimateScore(),
    answers: state.answers,
    timestamp: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(results, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `sat-practice-results-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  URL.revokeObjectURL(url);
  showNotification('Results exported successfully!');
}

function importQuestions() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.questions && Array.isArray(data.questions)) {
            // Add imported questions to the appropriate bank
            const section = data.section || 'rw';
            questionBanks[section] = [...questionBanks[section], ...data.questions];
            showNotification(`Imported ${data.questions.length} questions successfully!`);
          } else {
            showNotification('Invalid question file format!', 'error');
          }
        } catch (error) {
          showNotification('Error reading file!', 'error');
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function openAIHelper() {
  window.open('https://math-gpt.org/?gad_source=1&gad_campaignid=22392891529&gbraid=0AAAAA_KEbsxuugBcbtpA5SSWHJqF3s9gA&gclid=Cj0KCQjw18bEBhCBARIsAKuAFEYnzEG5_qsyg9jeP7K6IyWK_s0H-lyFgXvi8CXZl_AQm-ASuRTj7GcaAlgQEALw_wcB', '_blank');
}

function openCalculator() {
  window.open('https://www.desmos.com/practice', '_blank');
}

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type === 'error' ? 'error' : ''}`;
  notification.classList.add('show');
  
  if (type === 'error') {
    notification.style.background = 'var(--danger)';
    notification.style.color = 'white';
  } else {
    notification.style.background = 'var(--accent)';
    notification.style.color = '#071126';
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

function selectQuestions(section, difficulty = 'mixed') {
  const pool = questionBanks[section] || questionBanks.rw;
  const selected = [];
  
  // Select 25 questions with appropriate difficulty distribution
  let easyCount, mediumCount, hardCount;
  
  if(difficulty === 'hard') {
    easyCount = 3;
    mediumCount = 10; 
    hardCount = 12;
  } else if(difficulty === 'easy') {
    easyCount = 15;
    mediumCount = 8;
    hardCount = 2;
  } else { // mixed
    easyCount = 8;
    mediumCount = 12;
    hardCount = 5;
  }
  
  const easy = pool.filter(q => q.diff === 1);
  const medium = pool.filter(q => q.diff === 2);
  const hard = pool.filter(q => q.diff === 3);
  
  // Randomly select questions from each difficulty level
  if(easy.length >= easyCount) selected.push(...shuffleArray(easy).slice(0, easyCount));
  if(medium.length >= mediumCount) selected.push(...shuffleArray(medium).slice(0, mediumCount));
  if(hard.length >= hardCount) selected.push(...shuffleArray(hard).slice(0, hardCount));
  
  // Fill remaining slots if needed
  while(selected.length < 25 && selected.length < pool.length) {
    const remaining = shuffleArray(pool.filter(q => !selected.some(s => s.id === q.id)));
    if(remaining.length > 0) {
      selected.push(remaining[0]);
    } else break;
  }
  
  return shuffleArray(selected).slice(0, 25);
}

function shuffleArray(array) {
  const shuffled = [...array];
  for(let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function renderModule() {
  const area = document.getElementById('testArea');
  const sec = state.section === 'mixed' ? 
    (state.module === 1 ? 'rw' : 'math') : state.section;
    
  const difficulty = state.adaptive && state.module === 2 && 
    state.attempted > 0 && (state.correct / state.attempted >= 0.7) ? 'hard' : 'mixed';
  
  state.current = selectQuestions(sec, difficulty);
  area.innerHTML = '';
  
  document.getElementById('mnum').textContent = state.module;
  document.getElementById('progress').textContent = 
    `Module ${state.module} • ${sec.toUpperCase()} • ${difficulty === 'hard' ? 'Adaptive (Harder)' : difficulty === 'easy' ? 'Practice (Easier)' : 'Standard'}`;

  // Render questions
  state.current.forEach((q, idx) => {
    const block = document.createElement('div');
    block.className = 'q';
    
    // Handle passage-based questions
    if(q.stem.includes('\n\n')) {
      const parts = q.stem.split('\n\n');
      const passage = parts[0];
      const question = parts.slice(1).join('\n\n');
      
      block.innerHTML = `
        <div class="passage">${escapeHtml(passage)}</div>
        <h4>Question ${idx + 1}. ${escapeHtml(question)}</h4>
      `;
    } else {
      block.innerHTML = `<h4>Question ${idx + 1}. ${escapeHtml(q.stem)}</h4>`;
    }
    
    // Add difficulty indicator
    const difficultyBadge = document.createElement('span');
    difficultyBadge.className = 'tag';
    difficultyBadge.textContent = q.diff === 1 ? 'Easy' : q.diff === 2 ? 'Medium' : 'Hard';
    difficultyBadge.style.float = 'right';
    block.querySelector('h4').appendChild(difficultyBadge);
    
    const opts = document.createElement('div');
    opts.className = 'opt';
    
    q.choices.forEach((choice, i) => {
      const label = document.createElement('label');
      label.innerHTML = `
        <input type="radio" name="${q.id}" value="${i}"/>
        <div>${escapeHtml(choice)}</div>
      `;
      label.addEventListener('change', () => recordAnswer(q, i));
      opts.appendChild(label);
    });
    
    block.appendChild(opts);
    area.appendChild(block);
  });
  
  // Add finish button
  const finishBtn = document.createElement('button');
  finishBtn.textContent = shouldContinue() ? 'Finish Module & Continue' : 'Finish Test';
  finishBtn.className = 'finish-btn';
  finishBtn.onclick = nextModule;
  area.appendChild(finishBtn);

  // Start timer if enabled
  if(state.timed) {
    startTimer(sec === 'rw' ? 32 * 60 : 35 * 60);
  }
}

function shouldContinue() {
  return (state.section === 'mixed' && state.module === 1) || 
         (state.section !== 'mixed' && state.module === 1);
}

function recordAnswer(question, answerIndex) {
  if(state.answers[question.id] === undefined) {
    state.attempted++;
  }
  
  // Remove previous correct count if changing answer
  if(question._counted && state.answers[question.id] !== question.ans) {
    state.correct--;
    question._counted = false;
  }
  
  state.answers[question.id] = answerIndex;
  
  // Check if answer is correct
  if(answerIndex === question.ans) {
    if(!question._counted) {
      state.correct++;
      question._counted = true;
    }
  } else {
    question._counted = false;
  }
  
  updateScore();
}

function updateScore() {
  document.getElementById('correct').textContent = state.correct;
  document.getElementById('scaled').textContent = estimateScore();
}

function estimateScore() {
  if(state.attempted === 0) return '—';
  const percentage = state.correct / state.attempted;
  // SAT score range: 200-800 per section
  const scaled = Math.round(200 + (percentage * 600));
  return scaled;
}

function startTimer(seconds) {
  state.timeLeft = seconds;
  const clock = document.getElementById('clock');
  clock.classList.remove('hidden');
  clock.textContent = formatTime(seconds);
  
  clearInterval(state.timer);
  state.timer = setInterval(() => {
    state.timeLeft--;
    clock.textContent = formatTime(state.timeLeft);
    
    // Color coding for time warnings
    if(state.timeLeft <= 300) { // 5 minutes
      clock.style.color = 'var(--danger)';
    } else if(state.timeLeft <= 600) { // 10 minutes
      clock.style.color = 'var(--accent)';
    } else {
      clock.style.color = 'var(--fg)';
    }
    
    if(state.timeLeft <= 0) {
      clearInterval(state.timer);
      nextModule();
    }
  }, 1000);
}

function formatTime(seconds) {
  const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
  const secs = String(seconds % 60).padStart(2, '0');
  return `${minutes}:${secs}`;
}

function nextModule() {
  clearInterval(state.timer);
  document.getElementById('clock').classList.add('hidden');
  
  if(shouldContinue() && !state.finished) {
    showModuleResults();
    
    // Prepare for next module
    const currentCorrect = state.correct;
    const currentAttempted = state.attempted;
    
    state.module = 2;
    state.current = [];
    state.correct = currentCorrect;
    state.attempted = currentAttempted;
    
    // Add continue button
    const area = document.getElementById('testArea');
    const continueBtn = document.createElement('button');
    continueBtn.textContent = 'Continue to Module 2';
    continueBtn.className = 'finish-btn';
    continueBtn.onclick = () => renderModule();
    area.appendChild(continueBtn);
    
    return;
  }
  
  // Test finished
  state.finished = true;
  showModuleResults();
  document.getElementById('progress').textContent = 'Test Complete';
}

function showModuleResults() {
  const area = document.getElementById('testArea');
  const results = document.createElement('div');
  results.style.marginTop = '20px';
  results.innerHTML = `<h3 style="color:var(--fg);margin-bottom:16px">Module ${state.module} Results & Explanations</h3>`;
  
  state.current.forEach((question, index) => {
    const userAnswer = state.answers[question.id];
    const correctAnswer = question.ans;
    const isCorrect = userAnswer === correctAnswer;
    
    const resultBlock = document.createElement('div');
    resultBlock.className = 'q';
    resultBlock.style.borderLeft = `4px solid var(--${isCorrect ? 'accent' : 'danger'})`;
    
    // Question stem
    if(question.stem.includes('\n\n')) {
      const parts = question.stem.split('\n\n');
      const passage = parts[0];
      const questionText = parts.slice(1).join('\n\n');
      
      resultBlock.innerHTML = `
        <div class="passage">${escapeHtml(passage)}</div>
        <h4>Question ${index + 1}. ${escapeHtml(questionText)} ${isCorrect ? '✓' : '✗'}</h4>
      `;
    } else {
      resultBlock.innerHTML = `<h4>Question ${index + 1}. ${escapeHtml(question.stem)} ${isCorrect ? '✓' : '✗'}</h4>`;
    }
    
    // Answer choices with highlighting
    const opts = document.createElement('div');
    opts.className = 'opt';
    
    question.choices.forEach((choice, i) => {
      const label = document.createElement('label');
      label.innerHTML = `
        <input type="radio" name="${question.id}_result" value="${i}" disabled ${i === userAnswer ? 'checked' : ''}/>
        <div>${escapeHtml(choice)}</div>
      `;
      
      if (i === correctAnswer) {
        label.classList.add('correct');
      } else if (i === userAnswer && userAnswer !== correctAnswer) {
        label.classList.add('incorrect');
      }
      
      opts.appendChild(label);
    });
    
    resultBlock.appendChild(opts);
    
    // Explanation
    const explanation = document.createElement('div');
    explanation.className = 'explanation';
    explanation.innerHTML = `<strong>Explanation:</strong> ${escapeHtml(question.expl)}`;
    resultBlock.appendChild(explanation);
    
    results.appendChild(resultBlock);
  });
  
  area.appendChild(results);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>